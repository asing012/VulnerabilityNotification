#!/usr/bin/env python3
# Fetch latest updated CVEs


import requests
import os
from sendgrid import SendGridAPIClient
from sendgrid.helpers.mail import Mail
import dateutil.parser
from datetime import date


dateList=[]
#making API call
URL = "http://cve.circl.lu/api/last"
req = requests.get(url = URL)
data = req.json()
count = len(data)
writeFile = open("data.txt", "w+")
#extracting published time, id, references, and summary
for i in range(0, count):
#formatting date and appending it in the dateList
	publishedTime = data[i]['Published']
	rawDate  = dateutil.parser.parse(publishedTime)
	dateList.append(rawDate.date())
# writing data into "data.txt" file
	writeFile.write(str(data[i]['id'])+"<br>"+"Published on - "+str(dateList[i])+"<br>"+"Summary - "+str(data[i]['summary'])+"<br>"+"Reference - "+str(data[i]['references']).replace("[","").replace("'","").replace("'","").replace("]","")+"<br>"+"<br>")
writeFile.close()


#sg = SendGridAPIClient(os.environ.get('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'))

readFile = open("data.txt", "r")
fileData = readFile.read()
#print(fileData)
readFile.close()

#sending email
message = Mail(
	from_email='akshayc_118@hotmail.com',
    	to_emails='asingh@denimgroup.com',
    	subject='Latest updated CVEs',
    	html_content=fileData)
try:
	sg = SendGridAPIClient(os.environ.get('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'))
	response = sg.send(message)
	print(response.status_code)
except Exception as e:
    	print(e.message)



