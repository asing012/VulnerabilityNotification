#!/usr/bin/env python3
# Fetch latest updated CVEs


import requests
import os
from sendgrid import SendGridAPIClient
from sendgrid.helpers.mail import Mail
import dateutil.parser


cveList=[]
dateList=[]
referencesList=[]
summaryList=[]

#making API call
URL = "http://cve.circl.lu/api/last"
req = requests.get(url = URL)
data = req.json()
count = len(data)
f = open("data.txt", "w+")
#extracting published time, id, references, and summary
for i in range(0, count):
	cveList.append(data[i]['id'])
	referencesList.append(data[i]['references'])
	summaryList.append(data[i]['summary'])
	publishedTime = data[i]['Published']
#formatting date and appending it in the dateList
	rawDate  = dateutil.parser.parse(publishedTime)
	#strip = str(rawDate.date()).strip(']')
	#print(stripDate)
	#finalDate  = rawDate.date()
	dateList.append(rawDate.date())
	f.write(str(data[i]['id'])+"\n"+"Published on - "+str(dateList[i])+"\n"+"Summary - "+str(data[i]['summary'])+"\n"+"Reference - "+str(data[i]['references']).strip('[]')+"\n"+"\n")
f.close()



"""
#sending email
message = Mail(
	from_email='akshayc_118@hotmail.com',
    	to_emails='asingh@denimgroup.com',
    	subject='Latest updated CVEs',
    	html_content='<Date>'+str(dateList)+'<br><br>'+'CVE'+str(cveList)+'<br><br>'+'References'+str(referencesList)+'<br><br>'+'Summary'+str(summaryList))
try:
    	sg = SendGridAPIClient(os.environ.get('SENDGRID_API_KEY'))
    	response = sg.send(message)
    	print(response.status_code)
except Exception as e:
    	print(e.message)

"""

